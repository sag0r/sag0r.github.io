<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>AgroMukam - New Prescription</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap 4.6 CDNJS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.2/css/bootstrap.min.css">
    <!-- FontAwesome 5 CDNJS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- InstantSearch.js -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/instantsearch.css@8/themes/satellite-min.css">
    <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/typesense@1/dist/typesense.min.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/typesense-instantsearch-adapter@2/dist/typesense-instantsearch-adapter.min.js"></script>

    <style>
        button:focus {
            outline: none;
            box-shadow: none !important;
        }

        body {
            padding-top: 70px;
            padding-bottom: 70px;
            font-size: 14px;
            background: linear-gradient(rgba(105, 164, 31, 0.05), transparent);
        }

        .navbar-brand {
            color: #69A41F !important;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .card {
            border: none;
            border-radius: 0.75rem;
            margin-bottom: 0.75rem;
            box-shadow: 0px 4px 24px rgba(122, 172, 193, 0.16) !important;
        }

        .card-body {
            padding: 0.75rem 1rem;
        }

        .list-group-item {
            border: none;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            box-shadow: 0px 4px 24px rgba(122, 172, 193, 0.16) !important;
        }

        .product-name {
            font-weight: 600;
            font-size: 14px;
        }

        .vendor-price {
            font-size: 12px;
            color: #555;
        }

        .product-extra {
            display: none;
            margin-top: 0.5rem;
        }

        .dosage-input {
            width: 100%;
            font-size: 13px;
            margin-top: 2px;
        }

        .btn-brand {
            background-color: rgba(105, 164, 31, 1);
            color: #fff !important;
            border: none;
            transition: .2s all ease-in-out;
        }

        .btn-brand:hover {
            background-color: rgba(105, 164, 31, .7);
        }

        .sticky-top-filter {
            position: sticky;
            top: 54px;
            z-index: 1020;
            background-color: #fff;
            padding: 0.5rem 1rem;
        }

        .fixed-bottom-actions {
            padding: 0.5rem 0.75rem;
            border-top: 1px solid #ddd;
            background: #fff;
            box-shadow: 0px 4px 24px rgba(122, 172, 193, 0.16) !important;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .ais-Hits-item {
            padding: 0 !important;
        }

        #loadingState {
            min-height: 300px;
        }

        #prevPage,
        #nextPage {
            flex-shrink: 0;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border-color: rgba(105, 164, 31, 1);
            color: rgba(105, 164, 31, 1);
        }

        #prevPage:not(:disabled):hover,
        #nextPage:not(:disabled):hover {
            border-color: rgba(105, 164, 31, .8);
            background-color: rgba(105, 164, 31, .8);
            color: #fff;
        }

        #prevPage:disabled,
        #nextPage:disabled {
            cursor: not-allowed;
        }

        .ais-Hits-item,
        .ais-InfiniteHits-item,
        .ais-FrequentlyBoughtTogether-item,
        .ais-LookingSimilar-item,
        .ais-RelatedProducts-item,
        .ais-TrendingItems-item {
            box-shadow: none !important;
        }
    </style>
</head>

<body>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top shadow-sm">
        <a class="navbar-brand" href="home.html">AgroMukam</a>
    </nav>

    <div class="container mt-2">

        <!-- Customer Info -->
        <div class="card shadow-sm">
            <div class="card-body">
                <h6 class="mb-2 font-weight-bold">Customer Information</h6>
                <input type="text" class="form-control mb-1 form-control-sm" placeholder="Name">
                <input type="text" class="form-control mb-1 form-control-sm" placeholder="Phone">
                <input type="text" class="form-control mb-1 form-control-sm" placeholder="Address">
            </div>
        </div>

        <!-- Product Filters + Results -->
        <div class="card shadow-sm">
            <div class="sticky-top-filter m-2">
                <div id="searchbox"></div>
                <div id="searchStats" class="mt-1 text-muted small"></div>
            </div>

            <div class="d-flex align-items-center pb-4">
                <button id="prevPage" class="btn btn-sm btn-outline-secondary mx-2" style="display: none;"><i
                        class="fas fa-chevron-left"></i></button>

                <ul id="productList" class="list-group list-group-flush flex-grow-1">
                    <div id="loadingState" class="text-center my-3 text-muted">
                        <div class="spinner-border text-success spinner-border-sm" role="status"></div>
                        <span class="ml-2">Loading products...</span>
                    </div>
                </ul>

                <button id="nextPage" class="btn btn-sm btn-outline-secondary mx-2" style="display: none;"><i
                        class="fas fa-chevron-right"></i></button>
            </div>
        </div>

    </div>

    <!-- Fixed Bottom Actions -->
    <div class="fixed-bottom fixed-bottom-actions">
        <div>
            <strong>Order Total: </strong><span id="orderTotal">৳0</span>
        </div>
        <div>
            <button class="btn btn-brand btn-sm"><i class="fas fa-save"></i> Save</button>
            <button class="btn btn-success btn-sm"><i class="fas fa-arrow-left"></i> Back</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>

    <script>
        const vendorNames = [
            'Incepta Pharmaceuticals Ltd.',
            'NAVANA PHARMA',
            'Square Pharmaceuticals PLC.',
            'Eskayef Pharmaceuticals Limited',
            'The Acme Laboratories Ltd',
            'Advanced Chemical Industries Limited',
            'Popular Pharmaceuticals Ltd.'
        ];

        function buildVendorFilter() {
            if (vendorNames.length === 0) return "";
            const vendors = vendorNames.map(v => `"${v}"`).join(",");
            return `VendorName:=[${vendors}]`;
        }

        const typesenseInstantsearchAdapter = new TypesenseInstantSearchAdapter({
            server: {
                nodes: [
                    { host: "agromukam.com", port: "8108", protocol: "https" }
                ],
                apiKey: "eb9FsCbTLxZzvZwbRKnBb4770Ccrs01Q",
            },
            additionalSearchParameters: {
                queryBy: "Name,NameBn,FullDescription,FullDescriptionBn,VendorName,VendorStoreName",
                filterBy: buildVendorFilter(),
                per_page: 7,
                sort_by: "IsAvailableForAdvisors:desc"
            }
        });

        const searchClient = typesenseInstantsearchAdapter.searchClient;
        const search = instantsearch({ indexName: "agro_products", searchClient });

        // Searchbox
        search.addWidget(
            instantsearch.widgets.searchBox({ container: "#searchbox", placeholder: "Search product, vendor, description...", showReset: true, showSubmit: false })
        );

        // Hits
        search.addWidget(
            instantsearch.widgets.hits({
                container: "#productList",
                templates: {
                    item(hit) {
                        return `
                            <li class="list-group-item w-100 mb-0" data-price="${hit.ProductPrice.Price}">
                                <div class="d-flex align-items-center">
                                    <div>
                                        <img src="${hit.ProductImages[0]}" alt="${hit.Name}" style="width: 50px; height: 50px; object-fit: contain; border: 1px solid #ddd; border-radius: 0.25rem; margin-right: 10px;">
                                    </div>
                                    <div class="flex-fill">
                                        <div class="product-name ${hit.AdvisorIds.length > 0 ? 'text-success' : ''}">${hit.Name}</div>
                                        <div class="vendor-price">${hit.VendorStoreName} | ৳${hit.ProductPrice.Price}</div>
                                    </div>
                                    <button class="btn btn-sm btn-brand btn-add-product"><i class="fas fa-plus"></i> Add</button>
                                </div>
                                <div class="product-extra mt-2">
                                    <div class="form-row w-100 align-items-center px-2">
                                        <div class="left-controls d-flex flex-column flex-grow-1">
                                        <div class="input-group input-group-sm mb-1">
                                            <div class="input-group-prepend">
                                            <button class="btn btn-outline-secondary btn-decrease px-4" type="button">-</button>
                                            </div>
                                            <input type="text" class="form-control quantity-input text-center" value="1" readonly>
                                            <div class="input-group-append">
                                            <button class="btn btn-outline-secondary btn-increase px-4" type="button">+</button>
                                            </div>
                                        </div>
                                        <input type="text" class="form-control form-control-sm dosage-input" placeholder="Dosage & instructions">
                                        </div>
                                        <div class="right-close ml-2">
                                        <button class="btn btn-sm btn-danger btn-close-product px-4">×</button>
                                        </div>
                                    </div>
                                </div>
                            </li>`;
                    },
                    empty: `<div class="text-center text-muted my-3">No products found</div>`
                },
                transformItems(items) {
                    const loader = document.getElementById("loadingState");
                    if (loader) loader.style.display = "none";

                    const prevBtn = document.getElementById("prevPage");
                    if (prevBtn) prevBtn.style.display = "block";

                    const nextBtn = document.getElementById("nextPage");
                    if (nextBtn) nextBtn.style.display = "block";

                    return items;
                }
            })
        );

        // Stats
        search.addWidget(
            instantsearch.widgets.stats({
                container: '#searchStats',
                templates: {
                    text: data => `⚡️ ${data.nbHits} results found in ${data.processingTimeMS}ms`
                }
            })
        );

        // Hidden pagination for controlling pages
        const pagination = instantsearch.widgets.pagination({
            container: document.createElement('div'),
            scrollTo: false,
            showFirst: false,
            showLast: false,
            padding: 0
        });

        search.addWidgets([pagination]);
        search.start();

        // Function to update prev/next button disabled state
        function updatePageButtons(helper) {
            const prevBtn = document.getElementById('prevPage');
            const nextBtn = document.getElementById('nextPage');

            const currentPage = helper.state.page;
            const totalPages = helper.lastResults ? helper.lastResults.nbPages : 0;

            prevBtn.disabled = currentPage === 0;
            nextBtn.disabled = currentPage >= totalPages - 1;
        }

        // Attach to render event
        search.on('render', function () {
            updatePageButtons(search.helper);
        });

        // Prev/Next click events
        document.getElementById('prevPage').addEventListener('click', () => {
            if (!search.helper.state.page) return;
            search.helper.setPage(search.helper.state.page - 1).search();
        });

        document.getElementById('nextPage').addEventListener('click', () => {
            const state = search.helper.state;
            if (state.page >= search.helper.lastResults.nbPages - 1) return;
            search.helper.setPage(state.page + 1).search();
        });

        // Order total calculation & product events
        function updateOrderTotal() {
            let total = 0;
            $('#productList .product-extra:visible').each(function () {
                const li = $(this).closest('li');
                const quantity = parseInt($(this).find('.quantity-input').val()) || 0;
                const price = parseFloat(li.data('price')) || 0;
                total += quantity * price;
            });
            $('#orderTotal').text('৳' + total);
        }

        $(document).on('click', '.btn-add-product', function () {
            const li = $(this).closest('li');
            $(this).hide();
            li.find('.product-extra').slideDown(updateOrderTotal);
        });

        $(document).on('click', '.btn-close-product', function () {
            const li = $(this).closest('li');
            li.find('.product-extra').slideUp(updateOrderTotal);
            li.find('.btn-add-product').show();
            li.find('.quantity-input').val(1);
            li.find('.dosage-input').val('');
            updateOrderTotal();
        });

        $(document).on('click', '.btn-increase', function () {
            const input = $(this).closest('.input-group').find('.quantity-input');
            input.val(parseInt(input.val()) + 1);
            updateOrderTotal();
        });

        $(document).on('click', '.btn-decrease', function () {
            const input = $(this).closest('.input-group').find('.quantity-input');
            let val = parseInt(input.val());
            if (val > 1) input.val(val - 1);
            updateOrderTotal();
        });
    </script>
</body>

</html>