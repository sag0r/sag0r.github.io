<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bootstrap demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
    <link rel="stylesheet" href="jquery-ui-1.14.0.custom/jquery-ui.min.css" />
    <link href="https://cdn.datatables.net/2.1.2/css/dataTables.dataTables.css" rel="stylesheet" />
    <link href="style.css" rel="stylesheet" />

    <style>
        *:focus {
            outline: 0 !important;
            box-shadow: none !important;
        }

        table.dataTable th.dt-type-numeric:not(.editing),
        table.dataTable th.dt-type-date:not(.editing),
        table.dataTable td.dt-type-numeric:not(.editing),
        table.dataTable td.dt-type-date:not(.editing) {
            padding-right: 25px;
        }

        #example tbody td {
            position: relative;
        }

        #example tbody td.editable:not(.editing)::before {
            content: "\F4CB";
            position: absolute;
            right: 5px;
            top: 10px;
            font-family: 'bootstrap-icons';
            font-size: 12px;
        }

        #SimpleDataTable td.invalid-data {
            background: rgba(220, 53, 69, .5);
        }

        /* Tree view */
        #btnSourceDropdown {
            border: 1px solid #ced4da;
            color: #212529;
        }

        #btnSourceDropdown.show,
        #btnSourceDropdown:hover,
        #btnSourceDropdown:focus,
        #btnSourceDropdown:active {
            background: #fff !important;
        }

        .hummingbird-treeview,
        .hummingbird-treeview * {
            list-style: none;
            font-size: 14px;
            line-height: 20px;
        }

        .hummingbird-treeview label {
            font-weight: normal;
            padding-left: 8px;
        }


        .hummingbird-treeview input[type=checkbox] {
            width: 12px;
            height: 12px;
            padding: 0px;
            margin: 0px;
        }

        .hummingbird-treeview ul:not(.hummingbird-base) {
            display: none;
        }

        .hummingbird-treeview .bi {
            font-style: normal;
            cursor: pointer;
        }

        .search-dropdown {
            z-index: 1;
        }

        .search-dropdown li {
            cursor: pointer;
            cursor: pointer;
            padding: 2px 0;
            transition: .1s all linear;
        }

        .search-dropdown li,
        .search-dropdown .selected-item {
            font-size: 14px;
            line-height: 20px;
        }

        .search-dropdown .selected-item,
        .search-dropdown li:hover {
            color: #FDB604;
        }
    </style>
</head>

<body>

    <nav class="navbar fixed-top bg-white shadow-xl">
        <div class="container-fluid justify-content-start">
            <a class="navbar-brand site-logo d-flex flex-row" href="#">
                <div class="d-flex align-items-center">
                    <i class="bi bi-journal-bookmark-fill text-brand"></i>
                </div>
                <div class="d-flex flex-column ps-2">
                    <span class="text-brand">DataExpo</span>
                    <span class="text-muted" style="font-size: 14px;line-height: 16px;">Explore the Data</span>
                </div>
            </a>

            <div class="d-flex flex-row">
                <div class="d-flex ms-3">
                    <button type="button" class="btn btn-outline-brand btn-sm px-4 launch-upload-modal">
                        <i class="bi bi-file-earmark-excel"></i>
                        Upload
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="main-content-wrap">

        <div class="container-fluid pt-4">

            <!-- pre-content, displayed on page load -->
            <!-- <div class="pre-content-wrapper cursor-pointer launch-upload-modal" style="height: 80vh;">
                <div class="d-flex flex-column justify-content-center align-items-center h-100">

                    <i class="bi bi-file-earmark-excel" style="font-size: 62px; color: rgba(253, 182, 4, .5)"></i>

                    <h6 class="mt-3">
                        Click here to get started
                    </h6>
                </div>
            </div> -->

            <!-- content -->
            <main role="main" class="main-content-wrapper px-3">

                <div class="card data-table-card border-0 shadow-sm mt-5">
                    <div class="card-body">

                        <div class="row">

                            <div class="col mb-2 d-flex justify-content-center align-items-center">
                                <div class="d-flex justify-content-start align-items-center">
                                    <label class="mx-1">Sources</label>
                                    <div class="dropdown ms-1 me-4">
                                        <button class="btn btn-outline-secondary btn-sm rounded-xl dropdown-toggle"
                                            type="button" id="btnSourceDropdown" data-bs-toggle="dropdown"
                                            aria-expanded="false" data-bs-auto-close="outside">
                                            0 Selected
                                        </button>
                                        <div class="dropdown-menu border-0 shadow" aria-labelledby="btnSourceDropdown"
                                            style="min-width: 300px; width: auto !important; white-space: nowrap; max-height: 300px; overflow: hidden scroll;">
                                            <div id="treeview_container"
                                                class="hummingbird-treeview well h-scroll-large">
                                                <ul id="treeview" class="hummingbird-base m-0 px-2"></ul>
                                            </div>
                                        </div>
                                    </div>

                                    <label class="mx-1">Date</label>
                                    <div class="ms-1 me-2">
                                        <input type="text" class="form-control form-control-sm rounded-xl"
                                            id="SelectDate" />
                                    </div>

                                    <label class="mx-1">Type</label>
                                    <div class="mx-1">
                                        <select class="form-select form-select-sm rounded-pill ps-3" id="SelectType">
                                            <option value="0" selected> Select Type </option>
                                            <option value="1"> XLS / XLSX </option>
                                            <option value="2"> CSV </option>
                                            <option value="3"> DOC / DOCX </option>
                                            <option value="4"> PDF </option>
                                            <option value="5"> JPEG / PNG </option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="col-auto">
                                <div class="d-flex justify-content-center align-items-center mb-2">
                                    <button class="btn btn-sm bg-brand rounded-xl btn-show-upload-modal px-4 mx-1"
                                        disabled>
                                        <i class="bi bi-upload"></i>
                                        Upload
                                    </button>
                                    <button class="btn btn-sm btn-warning rounded-xl btn-add-row px-4 mx-1">
                                        <i class="bi bi-node-plus"></i>
                                        Add Row
                                    </button>
                                    <button class="btn btn-sm bg-brand rounded-xl btn-submit-data px-4 mx-1">
                                        <i class="bi bi-send"></i>
                                        Submit
                                    </button>
                                    <button class="btn btn-sm btn-warning rounded-xl px-4 mx-1 btn-export-to-xls">
                                        <i class="bi bi-download"></i>
                                        Download
                                    </button>
                                    <button class="btn btn-sm bg-brand rounded-xl btn-go-to-link px-4 mx-1">
                                        <i class="bi bi-share"></i>
                                        Go to Link
                                    </button>
                                </div>
                            </div>

                        </div>

                        <div class="alert-wrapper my-3"></div>

                        <table id="SimpleDataTable" class="display mt-3" cellspacing="0" width="100%">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="checkAll" class="form-check-input" /></th>
                                    <th>Name</th>
                                    <th>Office</th>
                                    <th>Position</th>
                                    <th>DOB</th>
                                    <th>Salary</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>

            </main>
        </div>

    </div>


    <div class="modal fade" id="fileUploadModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="file">Select Excel File</label>
                        <input type="file" name="file" id="file" class="form-control form-control-sm mt-2 rounded-xl" />
                        <div class="invalid-feedback" data-for="file"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-sm btn-outline-secondary px-5 rounded-xl"
                        data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-sm bg-brand text-white px-5 rounded-xl"
                        data-bs-dismiss="modal">
                        Understood
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div class="modal fade" id="deleteConfirmationModal" tabindex="-1" role="dialog"
        aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteConfirmationModalLabel">Confirm Deletion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this row?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Submit Modal -->
    <div class="modal fade" id="submitConfirmationModal" data-bs-backdrop="static" data-bs-keyboard="false"
        tabindex="-1" role="dialog" aria-labelledby="submitConfirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Submit</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h5> Are you sure you want to submit the data? </h5>

                    <p> <b>Source: </b> <span class="txt-source"></span> </p>
                    <p> <b>Type: </b> <span class="txt-type"></span> </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmSubmit">Submit</button>
                </div>
            </div>
        </div>
    </div>


    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="jquery-ui-1.14.0.custom/jquery-ui.min.js"></script>
    <script src="https://cdn.datatables.net/2.1.2/js/dataTables.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="dataTables.cellEdit.js"></script>
    <script src="tree-view.js"></script>

    <script>

        const DATA = [
            {
                "id": 1,
                "first_name": "Tiger",
                "last_name": "Nixon",
                "position": "System Architect",
                "email": "t.nixon@datatables.net",
                "office": "Edinburgh",
                "extn": 5421,
                "age": 61,
                "salary": 320800,
                "dob": "2011-04-25",
                "active": 0
            },
            {
                "id": 2,
                "first_name": "Garrett",
                "last_name": "Winters",
                "position": "Accountant",
                "email": "g.winters@datatables.net",
                "office": "Tokyo",
                "extn": 8422,
                "age": 63,
                "salary": 170750,
                "dob": "2011-07-25",
                "active": 1
            },
            {
                "id": 3,
                "first_name": "Ashton",
                "last_name": "Cox",
                "position": "Junior Technical Author",
                "email": "a.cox@datatables.net",
                "office": "San Francisco",
                "extn": 1562,
                "age": 66,
                "salary": 86000,
                "dob": "2009-01-12",
                "active": 0
            },
            {
                "id": 4,
                "first_name": "Cedric",
                "last_name": "Kelly",
                "position": "Senior Javascript Developer",
                "email": "c.kelly@datatables.net",
                "office": "Edinburgh",
                "extn": 6224,
                "age": 22,
                "salary": 433060,
                "dob": "2012-03-29",
                "active": 1
            },
            {
                "id": 5,
                "first_name": "Airi",
                "last_name": "Satou",
                "position": "Accountant",
                "email": "a.satou@datatables.net",
                "office": "Tokyo",
                "extn": 5407,
                "age": 33,
                "salary": 162700,
                "dob": "2008-11-28",
                "active": 1
            },
            {
                "id": 6,
                "first_name": "Brielle",
                "last_name": "Williamson",
                "position": "Integration Specialist",
                "email": "b.williamson@datatables.net",
                "office": "New York",
                "extn": 4804,
                "age": 61,
                "salary": 372000,
                "dob": "2012-12-02",
                "active": 1
            },
            {
                "id": 7,
                "first_name": "Herrod",
                "last_name": "Chandler",
                "position": "Sales Assistant",
                "email": "h.chandler@datatables.net",
                "office": "San Francisco",
                "extn": 9608,
                "age": 59,
                "salary": 137500,
                "dob": "2012-08-06",
                "active": 1
            },
            {
                "id": 8,
                "first_name": "Rhona",
                "last_name": "Davidson",
                "position": "Integration Specialist",
                "email": "r.davidson@datatables.net",
                "office": "Tokyo",
                "extn": 6200,
                "age": 55,
                "salary": 327900,
                "dob": "2010-10-14",
                "active": 0
            },
            {
                "id": 9,
                "first_name": "Colleen",
                "last_name": "Hurst",
                "position": "Javascript Developer",
                "email": "c.hurst@datatables.net",
                "office": "New York",
                "extn": 2360,
                "age": 39,
                "salary": 205500,
                "dob": "2009-09-15",
                "active": 0
            },
            {
                "id": 10,
                "first_name": "Sonya",
                "last_name": "Frost",
                "position": "Software Engineer",
                "email": "s.frost@datatables.net",
                "office": "Edinburgh",
                "extn": 1667,
                "age": 23,
                "salary": 103600,
                "dob": "2008-12-13",
                "active": 0
            },
            {
                "id": 11,
                "first_name": "Jena",
                "last_name": "Gaines",
                "position": "Office Manager",
                "email": "j.gaines@datatables.net",
                "office": "London",
                "extn": 3814,
                "age": 30,
                "salary": 90560,
                "dob": "2008-12-19",
                "active": 1
            },
            {
                "id": 12,
                "first_name": "Quinn",
                "last_name": "Flynn",
                "position": "Support Lead",
                "email": "q.flynn@datatables.net",
                "office": "Edinburgh",
                "extn": 9497,
                "age": 22,
                "salary": 342000,
                "dob": "2013-03-03",
                "active": 1
            }
        ];

        // reference to DataTable
        let DATA_TABLE = null;

        const SHOW_EDIT_ICON = true;
        const EDITABLE_COLUMNS = [0, 1, 2, 3, 4, 5];
        const DATATABLE_PAGING = false;
        const VALIDATION_ERROR_MSG = 'One or more cells have invalid data, please fix before submit.';
        const TREEVIEW_SELECTION_LEVEL = 4;

        // UPLOAD:: Controller => DataTable, Method => ParseContentFromXls
        const UPLOAD_URL = '/DataTable/ParseContentFromXls';
        // SUBMIT:: Controller => DataTable, Method => ParseContentFromXls
        const SUBMIT_URL = '/DataTable/SubmitData';

        // file upload modal
        const modalEl = document.getElementById('fileUploadModal');
        const modal = new bootstrap.Modal(modalEl, {
            backdrop: 'static'
        });

        // dummy options for input type == <select>
        const POSITIONS = [
            'System Architect', 'Accountant', 'Sales Assistant', 'Software Engineer', 'Office Manager', 'Support Lead',
            'Software Engineer',
            'Data Scientist',
            'Product Manager',
            'UX/UI Designer',
            'Project Manager',
            'Marketing Manager',
            'Business Analyst',
            'DevOps Engineer',
            'QA Engineer',
            'Financial Analyst',
            'Content Writer',
            'Human Resources Manager',
            'Sales Executive',
            'IT Support Specialist',
            'Network Administrator',
            'Mobile App Developer',
            'Graphic Designer',
            'Operations Manager',
            'Digital Marketing Specialist',
            'Database Administrator',
            'SEO Specialist',
            'Social Media Manager',
            'Customer Support Representative',
            'Account Manager',
            'Copywriter',
            'Cybersecurity Analyst',
            'Cloud Engineer',
            'Systems Analyst',
            'Data Engineer',
            'Web Developer',
            'Recruiter',
            'Creative Director',
            'IT Consultant',
            'AI/ML Engineer',
            'Video Editor',
            'Mechanical Engineer',
            'Electrical Engineer',
            'Architect',
            'Civil Engineer',
            'Legal Advisor',
            'Chief Executive Officer (CEO)',
            'Chief Financial Officer (CFO)',
            'Chief Technology Officer (CTO)',
            'Chief Operating Officer (COO)',
            'Front-End Developer',
            'Back-End Developer',
            'Full-Stack Developer',
            'Machine Learning Engineer',
            'Public Relations Specialist',
            'Event Manager',
            'Logistics Coordinator'
        ];
        const POSITION_OPTIONS = POSITIONS.map(p => ({ value: p, display: p }));

        const OFFICE_POSITION_MAPPING = [
            {
                location: 'New York',
                positions: ['System Architect', 'Accountant', 'Sales Assistant', 'Software Engineer']
            },
            {
                location: 'London',
                positions: ['SEO Specialist', 'Support Lead']
            },
            {
                location: 'Tokyo',
                positions: ['Logistics Coordinator', 'Event Manager']
            }
        ];

        // initialize datatable with editable feature
        function initializeDataTable(selector, data) {
            console.log('initializeDataTable(data)', data);
            // Column Definitions
            let columns = [
                {
                    data: 'active',
                    contentPadding: '0px',
                    orderable: false,
                    searchable: false,
                    render: function (data, type, row) {
                        const isChecked = parseInt(data) == 1;
                        return `
                            <span class="fake-checkbox" style="
                                display: inline-flex;
                                justify-content: center;
                                align-items: center;
                                width: 16px;
                                height: 16px;
                                border: 1px solid #dee2e6;
                                border-radius: 4px;
                                background: ${isChecked ? '#0d6efd' : '#fff'};
                                color: white;
                                font-size: 12px;
                                font-weight: bold;
                                line-height: 1;
                            ">
                                ${isChecked ? '✓' : ''}
                            </span>
                        `;
                    }
                },
                { data: 'first_name', contentPadding: '0px' },
                {
                    data: 'office',
                    type: 'string',
                    contentPadding: '0px',
                    width: '230px'
                },
                {
                    data: 'position',
                    contentPadding: '0px',
                    // use this className to determine data-type when validating cell value
                    className: 'dt-type-dropdown'
                },
                {
                    data: 'dob',
                    contentPadding: '0px',
                    // use this className to determine data-type when validating cell value
                    className: 'dt-type-datepicker',
                    render: function (data, type, row) {
                        const dt = new Date(data);
                        return dt.toLocaleDateString('en-AU');
                    }
                },
                {
                    data: 'salary',
                    type: 'num',
                    contentPadding: '0px',
                },
                {
                    data: 'id',
                    contentPadding: '0px',
                    width: '100px',
                    render: function (data, type, row) {
                        return `<button
                            type="button"
                            class="btn btn-sm bg-brand"
                            data-id="${data}"
                            onclick="deleteRow(${data})">
                                <i class="bi bi-trash"></i> Delete
                        </button>`;
                    }
                }
            ];

            // if column definition contains 'className' prop already 
            //  then prepend that value to 'editable'
            const getClassname = (columnObj) =>
                !!columnObj.className ? columnObj.className + ' editable' : 'editable';

            columns = columns.map((c, i) =>
                EDITABLE_COLUMNS.includes(i)
                    ? ({ ...c, className: getClassname(c) })
                    : c);

            // Initialize DataTable from JS array
            DATA_TABLE = new DataTable(selector, {
                columns,
                data,
                order: [[5, 'desc']],
                paging: DATATABLE_PAGING,
                destroy: true //destroy before initialize (if already initialized)
            });

            // Initialize editable cell plugin
            const wrapperHtml = `<div class="input-group input-group-sm">
                {content}
                <span class="input-group-text"
                    onclick='$(this).updateEditableCell($(this).prev())'>
                    <i class="bi bi-check2-all"></i>
                </span>
            </div>`;

            //destroy before initialize (if already initialized)
            DATA_TABLE.MakeCellsEditable('destroy');
            DATA_TABLE.MakeCellsEditable({
                onUpdate: cellUpdateCallback,
                inputCss: 'form-control form-control-sm',
                columns: EDITABLE_COLUMNS,
                wrapperHtml: wrapperHtml,
                inputTypes: [
                    {
                        column: 0,
                        type: 'checkbox'
                    },
                    {
                        column: 2,
                        type: 'textarea'
                    },
                    {
                        column: 3,
                        type: 'searchable-list',
                        options: POSITION_OPTIONS,
                        columnToMatchValue: 2,
                        mappings: OFFICE_POSITION_MAPPING
                    },
                    {
                        column: 4,
                        type: 'datepicker'
                    }
                ]
            });

        }

        function printCurrentTableData() {
            const data = DATA_TABLE.rows().data().toArray();
            console.log('Traversed:', data);
        }

        function cellUpdateCallback(updatedCell, updatedRow, oldValue) {
            console.log('------------------- updatedCell', updatedCell, $(updatedCell.node()));
            // validate whether a valid option is selected
            // fallback to oldValue if new value is null/empty
            // e.g: user searched for an option but selected non
            if ($(updatedCell.node()).hasClass('dt-type-dropdown')) {
                if (!updatedCell.data())
                    updatedCell.data(oldValue);

                const option = POSITION_OPTIONS.find(p => p.display == updatedCell.data());
                if (!option)
                    updatedCell.data(oldValue);
            }

            console.log('The new value for the cell is: ' + updatedCell.data());
            console.log('The values for each cell in that row are: ' + updatedRow.data());
            identifyInvalidCells();
            printCurrentTableData();
        }

        function getColumnNameForCurrentCell(td) {
            // Get the clicked cell
            const cell = DATA_TABLE.cell(td);

            // Get column index of the clicked cell
            const columnIndex = cell.index().column;

            // Get the column name from the DataTable settings
            const columnName = DATA_TABLE.column(columnIndex).header().textContent;

            return columnName;
        }

        function deleteRow(id) {
            // Show the modal
            $('#deleteConfirmationModal').modal('show');

            // Set the ID of the row to be deleted in a data attribute
            $('#confirmDelete').data('row-id', id);

            // Add an event listener to the delete button
            $('#confirmDelete').off('click').on('click', function () {
                const rowId = $(this).data('row-id');
                console.log('Deleting row with ID:', rowId);

                DATA_TABLE
                    .row($(`[data-id="${rowId}"]`).closest('tr'))
                    .remove()
                    .draw(false);

                printCurrentTableData();

                // Hide the modal after deletion
                $('#deleteConfirmationModal').modal('hide');
            });
        }

        function findDuplicateRows() {
            console.log('find duplcates');
            const data = DATA_TABLE.rows().data().toArray();
            const duplicates = data.reduce((acc, item) => {
                const key = `${item.office}-${item.position}`;
                acc[key] ? acc[key].push(item) : acc[key] = [item];
                return acc;
            }, {});

            const result = Object.values(duplicates).filter(arr => arr.length > 1).flat();
            console.log(`Found ${result.length} duplicates`);
            return result;
        }

        function identifyInvalidCells() {
            let [dropdownError, datePickerError, numericError, otherError, positionsError] = [0, 0, 0, 0, 0];

            $('td').removeClass('invalid-data');
            findDuplicateRows();

            let officeLoation = '';
            $(`#SimpleDataTable td`).each(function () {
                const textContent = $(this).text().trim();
                let valid = true;

                // get column name
                const columnName = getColumnNameForCurrentCell(this);

                // for 'office' column, save the value;
                // later use it to validate 'position' value
                if (columnName.toLowerCase() == 'office')
                    officeLoation = textContent;

                if ($(this).hasClass('dt-type-dropdown')) {
                    // data type: select option
                    // rule: must exist in position dropdown list

                    // Validate Positions Column
                    // 1. must exist in dropdown list
                    // 2. must align with office location
                    if (columnName.toLowerCase() == 'position') {
                        //console.log('positions dropdown = ', textContent);
                        const optionExist = POSITION_OPTIONS.find(p => p.display == textContent)
                        if (!optionExist) {
                            valid = false;
                            dropdownError++;
                        }

                        // office location is not null or empty
                        if (!!officeLoation) {
                            const mapping = OFFICE_POSITION_MAPPING.find(x => x.location == officeLoation);
                            if (!mapping) {
                                valid = false;
                                positionsError++;
                            } else {
                                const option = mapping.positions.find(x => x == textContent);
                                if (!option) {
                                    valid = false;
                                    positionsError++;
                                }
                            }
                        }
                    }

                } else if ($(this).hasClass('dt-type-datepicker')) {
                    // data type: date picker
                    // rule: can't be empty && must be valid date
                    if (!textContent || textContent.toLowerCase().includes('invalid date')) {
                        datePickerError++;
                        valid = false;
                    }
                } else if ($(this).hasClass('dt-type-numeric')) {
                    // data type: numeric
                    // rule: can't be empty && must be a number
                    const number = parseInt(textContent);
                    if (!textContent || isNaN(number)) {
                        numericError++;
                        valid = false;
                    }
                } else {
                    // data type: else, string and all
                    // rule: can't be null OR empty
                    if (!textContent) {
                        otherError++;
                        valid = false;
                    }
                }

                if (!valid)
                    $(this).addClass('invalid-data');
            });

            return ({ dropdownError, datePickerError, numericError, otherError, positionsError });
        }

        function showAlert(msg, isSuccess = true) {
            const alertClass = isSuccess ? 'alert-success' : 'alert-danger';
            const alertHtml = `<div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                ${msg}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>`;
            $('.alert-wrapper').html(alertHtml);
        }

        function showErrorAlertWithValidationSummary(msg, validationErrors) {
            const { dropdownError, datePickerError, numericError, otherError, positionsError } = validationErrors;
            let errorSummary = ``;

            if (dropdownError > 0)
                errorSummary += `<li> <b>${dropdownError}</b> Invalid Dropdown Value  </li>`;
            if (datePickerError > 0)
                errorSummary += `<li> <b>${datePickerError}</b> Invalid DatePicker Value  </li>`;
            if (numericError > 0)
                errorSummary += `<li> <b>${numericError}</b> Invalid Numeric Value  </li>`;
            if (otherError > 0)
                errorSummary += `<li> <b>${otherError}</b> Invalid String Value  </li>`;
            if (positionsError > 0)
                errorSummary += `<li> <b>${positionsError}</b> Poistion options doesn't exist in selected office location  </li>`;

            const duplicateRows = findDuplicateRows();
            if (duplicateRows.length > 0)
                errorSummary += `<li> <b>${duplicateRows.length}</b> Duplicate rows (office <> position) </li>`;

            const alertHtml = `<div class="alert alert-danger alert-dismissible fade show" role="alert">
                ${msg}
                <div class="mt-3"><ul> ${errorSummary} </ul></div>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>`;
            $('.alert-wrapper').html(alertHtml);
        }

        function toggleUploadButtonDisableState() {
            const source = $('#SelectSource').val();
            const type = $('#SelectType').val();
            if (source == 0 || type == 0) {
                $('.btn-show-upload-modal').attr('disabled', true);
            } else {
                $('.btn-show-upload-modal').removeAttr('disabled', true);
            }

            console.log('toggleUploadButtonDisableState', source, type);
        }

        // TREE VIEW SAMPLE DATA
        const DUMMY_DATA = [
            { id: 1, name: 'Australia', parent: 0 },
            { id: 4, name: 'New South Wales', parent: 1 },
            { id: 5, name: 'Queensland', parent: 1 },
            { id: 6, name: 'South Australia', parent: 1 },
            { id: 7, name: 'Tasmania', parent: 1 },
            { id: 8, name: 'Victoria', parent: 1 },
            { id: 9, name: 'Western Australia', parent: 1 },
            { id: 2, name: 'Bangladesh', parent: 0 },
            { id: 10, name: 'Barisal', parent: 2 },
            { id: 11, name: 'Chottagong', parent: 2 },
            { id: 12, name: 'Dhaka', parent: 2 },
            { id: 18, name: 'Dhaka', parent: 12 },
            { id: 24, name: 'All Educational Institudes', parent: 18 },
            { id: 27, name: 'Schools (secondary, higher secondary, madrasha)', parent: 24 },
            { id: 28, name: 'College', parent: 24 },
            { id: 29, name: 'Madrashah', parent: 24 },
            { id: 25, name: 'Hospitals', parent: 18 },
            { id: 26, name: 'Restaurants', parent: 18 },
            { id: 19, name: 'Faridpur', parent: 12 },
            { id: 20, name: 'Gazipur', parent: 12 },
            { id: 21, name: 'Gopalganj', parent: 12 },
            { id: 22, name: 'Kishoreonj', parent: 12 },
            { id: 23, name: 'Madaripur', parent: 12 },
            { id: 13, name: 'Khulna', parent: 2 },
            { id: 14, name: 'Mymensingh', parent: 2 },
            { id: 15, name: 'Rajshahi', parent: 2 },
            { id: 16, name: 'Rangpur', parent: 2 },
            { id: 17, name: 'Sylhet', parent: 2 },
            { id: 3, name: 'United States', parent: 0 },
        ];

        function createNode(rootEl, items, idPrefix, dataPrefix, level = 1) {
            for (const item of items) {
                const id = item.id;
                const idAttr = idPrefix + id;
                const dataAttr = dataPrefix + id;
                const children = DUMMY_DATA.filter(x => x.parent == id);

                // Disable checkboxes for levels 1 to TREEVIEW_SELECTION_LEVEL
                const isDisabled = level < TREEVIEW_SELECTION_LEVEL ? 'disabled' : '';

                const li = $('<li></li>');
                li.append(`
                    <label class="${children.length == 0 ? 'ml-3' : ''}">
                        <input
                            class="${children.length == 0 ? 'hummingbird-end-node' : ''}"
                            type="checkbox"
                            id="${idAttr}"
                            data-id="${dataAttr}"
                            ${isDisabled} />
                        ${item.name}
                    </label>
                `).appendTo(rootEl);

                if (children.length > 0) {
                    $('<i />', { 'class': 'bi bi-plus' }).prependTo(li);
                    createNode($('<ul></ul>'), children, `${idAttr}-`, `${dataAttr}-`, level + 1).appendTo(li);
                }
            }
            return rootEl;
        }

        function initializeTreeView() {
            // asuming first-level items' parent = 0;
            const items = DUMMY_DATA.filter(x => x.parent == 0);
            const selector = $('#treeview');
            const treeMarkup = createNode(selector, items, 'node-', 'custom-');
            //
            selector
                .append(treeMarkup)
                .hummingbird();
        }

        function disableTreeViewHigherLevels() {
            $('#treeview').find('input[type="checkbox"]').each(function () {
                const level = $(this).parents('ul').length; // Determines the depth level

                if (level < TREEVIEW_SELECTION_LEVEL) {
                    $(this).prop('checked', false).prop('disabled', true);
                }
            });
        }

        function exportToExcel(jsonData) {
            // Convert JSON to worksheet
            let worksheet = XLSX.utils.json_to_sheet(jsonData);

            // Create a new workbook and append the worksheet
            let workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Sheet1');

            // Save to Excel file
            XLSX.writeFile(workbook, `export_${Date.now()}.xlsx`);
        }

        $(document).ready(function () {

            $('.btn-show-upload-modal').click(function () {
                modal.show();
            });

            $('.launch-upload-modal').click(function () {
                $('.pre-content-wrapper').hide();
                $('.main-content-wrapper').show();
                initializeDataTable('#SimpleDataTable', DATA);
            });

            // Numeric Validation
            $(document).on('keydown', '#SimpleDataTable .form-control', function (e) {

                // Early trigger submit on 'Enter' press
                if (e.key === 'Enter') {
                    console.log('ENTER PRESSED, SUBMIT & QUIT EDITING');
                    $(this).blur();
                }
                const parent = $(this).closest('td');
                if (!!parent && parent.hasClass('dt-type-numeric')) {
                    console.log('VALIDATE NUMBERS');
                    if (
                        (e.key.length === 1 && !/[0-9\-]/.test(e.key)) ||  // Allow numbers and minus sign
                        (e.key === '-' && this.value.includes('-')) ||     // Prevent more than one minus sign
                        (e.key === '-' && this.selectionStart !== 0)       // Allow minus only at the beginning
                    ) {
                        e.preventDefault();
                    }
                }
            });

            // Dropdown select event
            $(document).on('click', '#editableDropdown .dropdown-item', function () {
                const textContent = $(this).text().trim();
                console.log('Selected dropdown item = ', textContent);
            });

            // Add new row to datatable
            $('.btn-add-row').click(function () {

                // Initialize DataTable with empty [] data if not already initialized
                if (!DataTable.isDataTable('#SimpleDataTable'))
                    initializeDataTable('#SimpleDataTable', []);

                const newRowData = {
                    first_name: '',
                    last_name: '',
                    position: '',
                    email: '',
                    office: '',
                    extn: '',
                    age: '',
                    salary: '',
                    dob: '',
                    active: "0",
                    id: DATA_TABLE.rows().data().toArray().length + 10
                };

                // Add new row to the table
                DATA_TABLE.row.add(newRowData).draw();
            });

            $('#confirmSubmit').click(function () {
                console.log('submit data');

                // exit edit mode for all cells that are in edit mode
                $('.editing .form-control, .editing .form-select').trigger('change');

                $('td').removeClass('invalid-data');

                // Initialize DataTable with empty [] data if not already initialized
                if (!DataTable.isDataTable('#SimpleDataTable'))
                    initializeDataTable('#SimpleDataTable', []);

                const data = DATA_TABLE.rows().data().toArray();

                // run validations
                const validationErrors = identifyInvalidCells();

                if ($('#SimpleDataTable td.invalid-data').length) {
                    showErrorAlertWithValidationSummary(VALIDATION_ERROR_MSG, validationErrors);
                } else {
                    console.log('all valid, submit to server');
                    showAlert('Submit Success');

                    // clear data-table
                    DATA_TABLE.clear().draw();
                }

                // hide modal
                $('#submitConfirmationModal').modal('hide');
            });

            // launch confirm submit modal
            $('.btn-submit-data').click(function () {

                // get select-option values
                const source = $('#SelectSource').val();
                const type = $('#SelectType').val();

                // show values on modal
                $('.txt-source').text(source);
                $('.txt-type').text(type);

                // show confirmation modal
                $('#submitConfirmationModal').modal('show');
            });

            // upload button's disable state
            $('#SelectSource, #SelectType').change(toggleUploadButtonDisableState);

            // Go to link
            $('.btn-go-to-link').click(function () {

                // get select-option values
                const source = $('#SelectSource').val();
                const type = $('#SelectType').val();

                //send to another link
                const url = `someurl?source=${source}&type=${type}`;
                window.open(url, '_blank');
            });

            // invoke initialize tree view
            initializeTreeView();

            $("#treeview").on("CheckUncheckDone", function () {
                var List = { "id": [], "dataid": [], "text": [] };
                $("#treeview").hummingbird("getChecked", { list: List, onlyEndNodes: true, onlyParents: false, fromThis: false });
                let cleanedData = List.text.map(item => item.replace('…', '').trim());
                console.log('CheckUncheckDone', cleanedData);
                $('#btnSourceDropdown').text(`${List.id.length} selected`);

                disableTreeViewHigherLevels();
            });

            $('#SelectDate').datepicker();

            $(document).on('keydown', function (e) {
                if (e.key === 'Escape') {
                    $('.editing .form-control, .editing .form-select, .editing .form-check-input').trigger('change');
                }
            });

            $('.btn-export-to-xls').click(function () {
                if (!DATA_TABLE)
                    return alert('No data to export, please initialize the table first...');

                const data = DATA_TABLE.rows().data().toArray();
                exportToExcel(data);
            });

            $(document).on('change', '#checkAll', function () {
                const isChecked = $(this).is(':checked');

                DATA_TABLE.rows().every(function () {
                    const cell = this.cell(this.index(), 0);
                    const data = this.data();

                    data.active = isChecked ? 1 : 0;
                    this.data(data);

                    cell.invalidate().render('display');
                });

                DATA_TABLE.draw(false);

                identifyInvalidCells();
                printCurrentTableData();
            });
        });
    </script>
</body>

</html>