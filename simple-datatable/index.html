<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bootstrap demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
    <link rel="stylesheet" href="jquery-ui-1.14.0.custom/jquery-ui.min.css" />
    <link href="https://cdn.datatables.net/2.1.2/css/dataTables.dataTables.css" rel="stylesheet" />
    <link href="style.css" rel="stylesheet" />

    <style>
        *:focus {
            outline: 0 !important;
            box-shadow: none !important;
        }

        table.dataTable th.dt-type-numeric:not(.editing),
        table.dataTable th.dt-type-date:not(.editing),
        table.dataTable td.dt-type-numeric:not(.editing),
        table.dataTable td.dt-type-date:not(.editing) {
            padding-right: 25px;
        }

        #example tbody td {
            position: relative;
        }

        #example tbody td.editable:not(.editing)::before {
            content: "\F4CB";
            position: absolute;
            right: 5px;
            top: 10px;
            font-family: 'bootstrap-icons';
            font-size: 12px;
        }

        #SimpleDataTable td.invalid-data {
            background: rgba(220, 53, 69, .5);
        }

        /* Tree view */
        #btnSourceDropdown {
            border: 1px solid #ced4da;
            color: #212529;
        }

        #btnSourceDropdown.show,
        #btnSourceDropdown:hover,
        #btnSourceDropdown:focus,
        #btnSourceDropdown:active {
            background: #fff !important;
        }

        .hummingbird-treeview,
        .hummingbird-treeview * {
            list-style: none;
            font-size: 14px;
            line-height: 20px;
        }

        .hummingbird-treeview label {
            font-weight: normal;
            padding-left: 8px;
        }


        .hummingbird-treeview input[type=checkbox] {
            width: 12px;
            height: 12px;
            padding: 0px;
            margin: 0px;
        }

        .hummingbird-treeview ul:not(.hummingbird-base) {
            display: none;
        }

        .hummingbird-treeview .bi {
            font-style: normal;
            cursor: pointer;
        }

        .search-dropdown {
            z-index: 1;
        }

        .search-dropdown li {
            cursor: pointer;
            cursor: pointer;
            padding: 2px 0;
            transition: .1s all linear;
        }

        .search-dropdown li,
        .search-dropdown .selected-item {
            font-size: 14px;
            line-height: 20px;
        }

        .search-dropdown .selected-item,
        .search-dropdown li:hover {
            color: #FDB604;
        }

        button.nav-link {
            color: #16161d !important;
        }

        button.nav-link:hover,
        button.nav-link:focus,
        button.nav-link:active,
        button.nav-link:visited,
        button.nav-link.active {
            background-color: #FDB604 !important;
            border-color: #FDB604 !important;
        }

        .custom-checkbox {
            appearance: none;
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            position: relative;
            display: inline-block;
            background-color: #e0e0e0;
        }

        .custom-checkbox.yes:checked {
            background-color: #28a745;
            /* green */
        }

        .custom-checkbox.no:checked {
            background-color: #dc3545;
            /* red */
        }

        .custom-checkbox:checked::before {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 16px;
            height: 16px;
            transform: translate(-50%, -50%);
            background-repeat: no-repeat;
            background-size: contain;
        }

        .custom-checkbox.yes:checked::before {
            background-image: url("data:image/svg+xml,%3Csvg fill='white' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M20.285 6.709l-11.025 11.025-5.546-5.546 1.414-1.414 4.132 4.132 9.611-9.611z'/%3E%3C/svg%3E");
        }

        .custom-checkbox.no:checked::before {
            background-image: url("data:image/svg+xml,%3Csvg fill='white' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M18.364 5.636l-1.414-1.414L12 9.172 7.05 4.222 5.636 5.636 10.586 10.586 5.636 15.536l1.414 1.414L12 12.828l4.95 4.95 1.414-1.414-4.95-4.95z'/%3E%3C/svg%3E");
        }

        .fake-checkbox {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 16px;
            height: 16px;
            background-color: #e0e0e0;
            border-radius: 4px;
            font-size: 16px;
            font-weight: bold;
            line-height: 1;
            cursor: pointer;
            background-repeat: no-repeat;
            background-size: contain;
        }

        .fake-checkbox.checked {
            background-color: #28a745;
            /* Green background for Yes */
            color: white;
            background-image: url("data:image/svg+xml,%3Csvg fill='white' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M20.285 6.709l-11.025 11.025-5.546-5.546 1.414-1.414 4.132 4.132 9.611-9.611z'/%3E%3C/svg%3E");
            /* Green check mark */
        }

        .fake-checkbox.unchecked {
            background: transparent;
            border: 1px solid #28a745;
            /* Green color for Yes when unchecked */
        }

        .fake-checkbox.no-checked {
            background-color: #dc3545;
            /* Red background for No */
            color: white;
            background-image: url("data:image/svg+xml,%3Csvg fill='white' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M18.364 5.636l-1.414-1.414L12 9.172 7.05 4.222 5.636 5.636 10.586 10.586 5.636 15.536l1.414 1.414L12 12.828l4.95 4.95 1.414-1.414-4.95-4.95z'/%3E%3C/svg%3E");
            /* Red cross mark */
        }

        .fake-checkbox.no-unchecked {
            background: transparent;
            border: 1px solid #dc3545;
            /* Red color for No when unchecked */
        }

        .form-check-input:checked {
            background-color: #FDB604;
            border-color: #FDB604;
        }

        .search-item.highlighted {
            background-color: #f0f0f0;
            cursor: pointer;
        }

        .focusable-element-wrapper:focus,
        td.editable:focus-within {
            background: rgba(253, 182, 4, .7) !important;
        }
    </style>
</head>

<body>

    <nav class="navbar fixed-top bg-white shadow-xl">
        <div class="container-fluid justify-content-start">
            <a class="navbar-brand site-logo d-flex flex-row" href="#">
                <div class="d-flex align-items-center">
                    <i class="bi bi-journal-bookmark-fill text-brand"></i>
                </div>
                <div class="d-flex flex-column ps-2">
                    <span class="text-brand">DataExpo</span>
                    <span class="text-muted" style="font-size: 14px;line-height: 16px;">Explore the Data</span>
                </div>
            </a>

            <div class="d-flex flex-row">
                <div class="d-flex ms-3">
                    <button type="button" class="btn btn-outline-brand btn-sm px-4 launch-upload-modal">
                        <i class="bi bi-file-earmark-excel"></i>
                        Upload
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="main-content-wrap">

        <div class="container-fluid pt-4">

            <!-- pre-content, displayed on page load -->
            <!-- <div class="pre-content-wrapper cursor-pointer launch-upload-modal" style="height: 80vh;">
                <div class="d-flex flex-column justify-content-center align-items-center h-100">

                    <i class="bi bi-file-earmark-excel" style="font-size: 62px; color: rgba(253, 182, 4, .5)"></i>

                    <h6 class="mt-3">
                        Click here to get started
                    </h6>
                </div>
            </div> -->

            <!-- content -->
            <main role="main" class="main-content-wrapper px-3">

                <div class="card data-table-card border-0 shadow-sm mt-5">
                    <div class="card-body">

                        <div class="row">

                            <div class="col mb-2 d-flex justify-content-center align-items-center">
                                <div class="d-flex justify-content-start align-items-center">
                                    <label class="mx-1">Sources</label>
                                    <div class="dropdown ms-1 me-4">
                                        <button class="btn btn-outline-secondary btn-sm rounded-xl dropdown-toggle"
                                            type="button" id="btnSourceDropdown" data-bs-toggle="dropdown"
                                            aria-expanded="false" data-bs-auto-close="outside">
                                            0 Selected
                                        </button>
                                        <div class="dropdown-menu border-0 shadow" aria-labelledby="btnSourceDropdown"
                                            style="min-width: 300px; width: auto !important; white-space: nowrap; max-height: 300px; overflow: hidden scroll;">
                                            <div id="treeview_container"
                                                class="hummingbird-treeview well h-scroll-large">
                                                <ul id="treeview" class="hummingbird-base m-0 px-2"></ul>
                                            </div>
                                        </div>
                                    </div>

                                    <label class="mx-1">Date</label>
                                    <div class="ms-1 me-2">
                                        <input type="text" class="form-control form-control-sm rounded-xl"
                                            id="SelectDate" />
                                    </div>

                                    <label class="mx-1">Type</label>
                                    <div class="mx-1">
                                        <select class="form-select form-select-sm rounded-pill ps-3" id="SelectType">
                                            <option value="0" selected> Select Type </option>
                                            <option value="1"> XLS / XLSX </option>
                                            <option value="2"> CSV </option>
                                            <option value="3"> DOC / DOCX </option>
                                            <option value="4"> PDF </option>
                                            <option value="5"> JPEG / PNG </option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="col-auto">
                                <div class="d-flex justify-content-center align-items-center mb-2">
                                    <button class="btn btn-sm bg-brand rounded-xl btn-show-upload-modal px-4 mx-1"
                                        disabled>
                                        <i class="bi bi-upload"></i>
                                        Upload
                                    </button>
                                    <button class="btn btn-sm btn-warning rounded-xl btn-add-row px-4 mx-1">
                                        <i class="bi bi-node-plus"></i>
                                        Add Row
                                    </button>
                                    <button class="btn btn-sm bg-brand rounded-xl btn-submit-data px-4 mx-1">
                                        <i class="bi bi-send"></i>
                                        Submit
                                    </button>
                                    <button class="btn btn-sm btn-warning rounded-xl px-4 mx-1 btn-export-to-xls">
                                        <i class="bi bi-download"></i>
                                        Download
                                    </button>
                                    <button class="btn btn-sm bg-brand rounded-xl btn-go-to-link px-4 mx-1">
                                        <i class="bi bi-share"></i>
                                        Go to Link
                                    </button>
                                </div>
                            </div>

                        </div>

                        <div class="alert-wrapper my-3"></div>

                        <nav class="mt-4">
                            <div class="nav nav-tabs justify-content-center align-items-center" id="nav-tab"
                                role="tablist">
                                <button class="nav-link active" id="nav-editing-tab" data-bs-toggle="tab"
                                    data-bs-target="#nav-editing" type="button" role="tab" aria-controls="nav-editing"
                                    aria-selected="true">
                                    <i class="bi bi-pencil-square me-2"></i>
                                    Editing
                                </button>
                                <button class="nav-link" id="nav-preview-tab" data-bs-toggle="tab"
                                    data-bs-target="#nav-preview" type="button" role="tab" aria-controls="nav-preview"
                                    aria-selected="false">
                                    <i class="bi bi-eye me-2"></i>
                                    Preview
                                </button>
                            </div>
                        </nav>
                        <div class="tab-content" id="nav-tabContent">
                            <div class="tab-pane fade show active" id="nav-editing" role="tabpanel"
                                aria-labelledby="nav-editing-tab">

                                <table id="SimpleDataTable" class="display mt-3" cellspacing="0" width="100%">
                                    <thead>
                                        <tr>
                                            <th>
                                                <input type="checkbox" id="checkAll" class="form-check-input" />
                                                Approve
                                            </th>
                                            <th>Name</th>
                                            <th>Email</th>
                                            <th>Office</th>
                                            <th>Position</th>
                                            <th>DOB</th>
                                            <th>Salary</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                </table>

                            </div>
                            <div class="tab-pane fade" id="nav-preview" role="tabpanel"
                                aria-labelledby="nav-preview-tab">

                                <h5 class="text-brand my-4 text-center">
                                    'Preview Tab' Content
                                </h5>

                                <table id="PreviewDataTable" class="display mt-3" cellspacing="0" width="100%"
                                    tabindex="0">
                                    <thead>
                                        <tr>
                                            <th>Active</th>
                                            <th>Name</th>
                                            <th>Email</th>
                                            <th>Office</th>
                                            <th>Position</th>
                                            <th>DOB</th>
                                            <th>Salary</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                </table>

                            </div>
                        </div>

                    </div>
                </div>

            </main>
        </div>

    </div>


    <div class="modal fade" id="fileUploadModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="file">Select Excel File</label>
                        <input type="file" name="file" id="file" class="form-control form-control-sm mt-2 rounded-xl" />
                        <div class="invalid-feedback" data-for="file"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-sm btn-outline-secondary px-5 rounded-xl"
                        data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-sm bg-brand text-white px-5 rounded-xl"
                        data-bs-dismiss="modal">
                        Understood
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div class="modal fade" id="deleteConfirmationModal" tabindex="-1" role="dialog"
        aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteConfirmationModalLabel">Confirm Deletion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this row?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Submit Modal -->
    <div class="modal fade" id="submitConfirmationModal" data-bs-backdrop="static" data-bs-keyboard="false"
        tabindex="-1" role="dialog" aria-labelledby="submitConfirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Submit</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h5> Are you sure you want to submit the data? </h5>

                    <p> <b>Source: </b> <span class="txt-source"></span> </p>
                    <p> <b>Type: </b> <span class="txt-type"></span> </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmSubmit">Submit</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="jquery-ui-1.14.0.custom/jquery-ui.min.js"></script>
    <script src="https://cdn.datatables.net/2.1.2/js/dataTables.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="dataTables.cellEdit.js"></script>
    <script src="tree-view.js"></script>
    <script src="session-manager.js"></script>

    <script>

        const DATA = [
            {
                "id": 1,
                "first_name": "Tiger",
                "last_name": "Nixon",
                "position": 0,
                "email": "t.nixon@datatables.net",
                "office": "Edinburgh",
                "extn": 5421,
                "age": 61,
                "salary": 320800,
                "dob": "2011-04-25",
                "active": 2
            },
            {
                "id": 2,
                "first_name": "Garrett",
                "last_name": "Winters",
                "position": "Accountant",
                "email": "g.winters@datatables.net",
                "office": "Tokyo",
                "extn": 8422,
                "age": 63,
                "salary": 170750,
                "dob": "2011-07-25",
                "active": 1
            },
            {
                "id": 3,
                "first_name": "Ashton",
                "last_name": "Cox",
                "position": "Junior Technical Author",
                "email": "a.cox@datatables.net",
                "office": "San Francisco",
                "extn": 1562,
                "age": 66,
                "salary": 86000,
                "dob": "2009-01-12",
                "active": 0
            },
            {
                "id": 4,
                "first_name": "Cedric",
                "last_name": "Kelly",
                "position": "Senior Javascript Developer",
                "email": "c.kelly@datatables.net",
                "office": "Edinburgh",
                "extn": 6224,
                "age": 22,
                "salary": 433060,
                "dob": "2012-03-29",
                "active": 1
            },
            {
                "id": 5,
                "first_name": "Airi",
                "last_name": "Satou",
                "position": "Accountant",
                "email": "a.satou@datatables.net",
                "office": "Tokyo",
                "extn": 5407,
                "age": 33,
                "salary": 162700,
                "dob": "2008-11-28",
                "active": 1
            },
            {
                "id": 6,
                "first_name": "Brielle",
                "last_name": "Williamson",
                "position": "Integration Specialist",
                "email": "b.williamson@datatables.net",
                "office": "New York",
                "extn": 4804,
                "age": 61,
                "salary": 372000,
                "dob": "2012-12-02",
                "active": 1
            },
            {
                "id": 7,
                "first_name": "Herrod",
                "last_name": "Chandler",
                "position": "Sales Assistant",
                "email": "h.chandler@datatables.net",
                "office": "San Francisco",
                "extn": 9608,
                "age": 59,
                "salary": 137500,
                "dob": "2012-08-06",
                "active": 1
            },
            {
                "id": 8,
                "first_name": "Rhona",
                "last_name": "Davidson",
                "position": "Integration Specialist",
                "email": "r.davidson@datatables.net",
                "office": "Tokyo",
                "extn": 6200,
                "age": 55,
                "salary": 327900,
                "dob": "2010-10-14",
                "active": 0
            },
            {
                "id": 9,
                "first_name": "Colleen",
                "last_name": "Hurst",
                "position": "Javascript Developer",
                "email": "c.hurst@datatables.net",
                "office": "New York",
                "extn": 2360,
                "age": 39,
                "salary": 205500,
                "dob": "2009-09-15",
                "active": 0
            },
            {
                "id": 10,
                "first_name": "Sonya",
                "last_name": "Frost",
                "position": "Software Engineer",
                "email": "s.frost@datatables.net",
                "office": "Edinburgh",
                "extn": 1667,
                "age": 23,
                "salary": 103600,
                "dob": "2008-12-13",
                "active": 0
            },
            {
                "id": 11,
                "first_name": "Jena",
                "last_name": "Gaines",
                "position": "Office Manager",
                "email": "j.gaines@datatables.net",
                "office": "London",
                "extn": 3814,
                "age": 30,
                "salary": 90560,
                "dob": "2008-12-19",
                "active": 1
            },
            {
                "id": 12,
                "first_name": "Quinn",
                "last_name": "Flynn",
                "position": "Support Lead",
                "email": "q.flynn@datatables.net",
                "office": "Edinburgh",
                "extn": 9497,
                "age": 22,
                "salary": 342000,
                "dob": "2013-03-03",
                "active": 1
            }
        ];

        // reference to DataTable
        let DATA_TABLE = null;

        const SHOW_EDIT_ICON = true;
        const EDITABLE_COLUMNS = [1, 2, 3, 4, 5, 6];
        const DATATABLE_PAGING = false;
        const VALIDATION_ERROR_MSG = 'One or more cells have invalid data, please fix before submit.';
        const TREEVIEW_SELECTION_LEVEL = 4;
        const EMAIL_REGEX = /^[^\s@]+@[a-zA-Z0-9-]+\.[a-zA-Z]{2,}(\.[a-zA-Z]{2,})?$/;
        const EMAIL_SEPARATOR = ':';

        // UPLOAD:: Controller => DataTable, Method => ParseContentFromXls
        const UPLOAD_URL = '/DataTable/ParseContentFromXls';
        // SUBMIT:: Controller => DataTable, Method => ParseContentFromXls
        const SUBMIT_URL = '/DataTable/SubmitData';

        // file upload modal
        const modalEl = document.getElementById('fileUploadModal');
        const modal = new bootstrap.Modal(modalEl, {
            backdrop: 'static'
        });

        // dummy options for input type == <select>
        const POSITIONS = [
            'System Architect', 'Accountant', 'Sales Assistant', 'Software Engineer', 'Office Manager', 'Support Lead',
            'Software Engineer',
            'Data Scientist',
            'Product Manager',
            'UX/UI Designer',
            'Project Manager',
            'Marketing Manager',
            'Business Analyst',
            'DevOps Engineer',
            'QA Engineer',
            'Financial Analyst',
            'Content Writer',
            'Human Resources Manager',
            'Sales Executive',
            'IT Support Specialist',
            'Network Administrator',
            'Mobile App Developer',
            'Graphic Designer',
            'Operations Manager',
            'Digital Marketing Specialist',
            'Database Administrator',
            'SEO Specialist',
            'Social Media Manager',
            'Customer Support Representative',
            'Account Manager',
            'Copywriter',
            'Cybersecurity Analyst',
            'Cloud Engineer',
            'Systems Analyst',
            'Data Engineer',
            'Web Developer',
            'Recruiter',
            'Creative Director',
            'IT Consultant',
            'AI/ML Engineer',
            'Video Editor',
            'Mechanical Engineer',
            'Electrical Engineer',
            'Architect',
            'Civil Engineer',
            'Legal Advisor',
            'Chief Executive Officer (CEO)',
            'Chief Financial Officer (CFO)',
            'Chief Technology Officer (CTO)',
            'Chief Operating Officer (COO)',
            'Front-End Developer',
            'Back-End Developer',
            'Full-Stack Developer',
            'Machine Learning Engineer',
            'Public Relations Specialist',
            'Event Manager',
            'Logistics Coordinator'
        ];
        const POSITION_OPTIONS = POSITIONS.map(p => ({ value: p.toLowerCase(), display: p }));

        const OFFICE_POSITION_MAPPING = [
            {
                location: 'New York',
                positions: ['System Architect', 'Accountant', 'Sales Assistant', 'Software Engineer']
            },
            {
                location: 'London',
                positions: ['SEO Specialist', 'Support Lead']
            },
            {
                location: 'Tokyo',
                positions: ['Logistics Coordinator', 'Event Manager']
            }
        ];

        // initialize datatable with editable feature
        function initializeDataTable(selector, data) {
            console.log('initializeDataTable(data)', data);

            // Column Definitions
            let columns = [
                {
                    data: 'active',
                    contentPadding: '0px',
                    orderable: false,
                    searchable: false,
                    className: 'dt-type-checkbox',
                    width: '200px',
                    render: function (data, type, row) {
                        const oldValue = parseInt(data);
                        const yesChecked = oldValue == 1 ? "checked" : "";
                        const noChecked = oldValue == 2 ? "checked" : "";

                        return `
                            <div class="d-flex flex-row">
                                <div class="d-flex flex-fill flex-row align-items-center mb-1 focusable-element-wrapper">
                                    <div class="d-flex align-items-center">
                                        <input type='checkbox' class='custom-checkbox ejbeatycelledit-multi yes' data-value='1' ${yesChecked}>
                                    </div>
                                    <div class="d-flex align-items-center ms-2">
                                        <span class="text-success" style="font-size: 16px;">Approve</span>
                                    </div>
                                </div>
                                <div class="d-flex flex-fill flex-row align-items-center focusable-element-wrapper ms-4">
                                    <div class="d-flex align-items-center">
                                        <input type='checkbox' class='custom-checkbox ejbeatycelledit-multi no' data-value='2' ${noChecked}>
                                    </div>
                                    <div class="d-flex align-items-center ms-2">
                                        <span class="text-danger" style="font-size: 16px;">Reject</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                },
                { data: 'first_name', contentPadding: '0px' },
                {
                    data: 'email',
                    contentPadding: '0px',
                    className: 'dt-type-email'
                },
                {
                    data: 'office',
                    type: 'string',
                    contentPadding: '0px',
                    width: '230px',
                    className: 'len-40',
                    render: function (data, type, row) {
                        const url = `https://www.google.com/maps?q=${data}`;
                        return `<a href="${url}" target="_blank" class="text-decoration-none text-brand">
                            ${data}
                            <i class="bi bi-box-arrow-up-right" style="font-size: 10px;"></i>
                        </a>`;
                    }
                },
                {
                    data: 'position',
                    contentPadding: '0px',
                    // use this className to determine data-type when validating cell value
                    className: 'dt-type-dropdown'
                },
                {
                    data: 'dob',
                    contentPadding: '0px',
                    // use this className to determine data-type when validating cell value
                    className: 'dt-type-datepicker',
                    render: function (data, type, row) {
                        const dt = new Date(data);
                        return dt.toLocaleDateString('en-AU');
                    }
                },
                {
                    data: 'salary',
                    type: 'num',
                    contentPadding: '0px',
                    render: function (data, type, row) {
                        const value = Number(data);

                        if (type === 'display') {
                            return isNaN(value) ? '$0' : '$' + value.toLocaleString('en-AU');
                        }

                        return value;
                    }
                },
                {
                    data: 'id',
                    contentPadding: '0px',
                    width: '100px',
                    render: function (data, type, row) {
                        return `<div class="focusable-element-wrapper">
                            <button
                                type="button"
                                class="btn btn-sm bg-brand"
                                data-id="${data}"
                                onclick="deleteRow(${data})">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </div>`;
                    }
                }
            ];

            // if column definition contains 'className' prop already 
            //  then prepend that value to 'editable'
            const getClassname = (columnObj) =>
                !!columnObj.className ? columnObj.className + ' editable' : 'editable';

            columns = columns.map((c, i) =>
                EDITABLE_COLUMNS.includes(i)
                    ? ({ ...c, className: getClassname(c) })
                    : c);

            // Initialize DataTable from JS array
            DATA_TABLE = new DataTable(selector, {
                columns,
                data,
                order: [[5, 'desc']],
                paging: DATATABLE_PAGING,
                destroy: true, //destroy before initialize (if already initialized)
                initComplete: function () {
                    const table = this.api();
                    table.rows().every(function () {
                        disableCertainCell(this, table); // 'this' is a row
                    });
                }
            });

            // overried checkbox column's definition for checkbox behavior
            const CB_COL_INDEX = 0;
            columns[CB_COL_INDEX] = {
                data: 'active',
                className: 'dt-type-checkbox',
                render: function (data, type, row) {
                    const oldValue = parseInt(data);
                    const isChecked = oldValue == 1 ? "checked" : "";

                    return `
                        <div class="d-flex flex-column justify-content-center align-items-center">
                            <input 
                                type='checkbox' 
                                class='form-check-input' 
                                data-value='${oldValue}'
                                ${isChecked} />
                        </div>
                    `;
                }
            };

            // initialize secondary table
            new DataTable('#PreviewDataTable', {
                columns,
                data,
                order: [[5, 'desc']],
                paging: DATATABLE_PAGING,
                destroy: true //destroy before initialize (if already initialized)
            });

            // Initialize editable cell plugin
            const wrapperHtml = `<div class="input-group input-group-sm">
                {content}
                <span class="input-group-text"
                    onclick='$(this).updateEditableCell($(this).prev())'>
                    <i class="bi bi-check2-all"></i>
                </span>
            </div>`;

            //destroy before initialize (if already initialized)
            DATA_TABLE.MakeCellsEditable('destroy');
            DATA_TABLE.MakeCellsEditable({
                onUpdate: cellUpdateCallback,
                inputCss: 'form-control form-control-sm',
                columns: EDITABLE_COLUMNS,
                wrapperHtml: wrapperHtml,
                inputTypes: [
                    {
                        column: 3,
                        type: 'textarea'
                    },
                    {
                        column: 4,
                        type: 'searchable-list',
                        options: POSITION_OPTIONS,
                        columnToMatchValue: 2,
                        mappings: OFFICE_POSITION_MAPPING
                    },
                    {
                        column: 5,
                        type: 'datepicker'
                    }
                ]
            });

            setTimeout(() => {
                DATA_TABLE.columns.adjust().draw(false);
            }, 0);
        }

        function printCurrentTableData() {
            const data = DATA_TABLE.rows().data().toArray();
            console.log('Traversed:', data);
        }

        function disableCertainCell(row, tableInstance = DATA_TABLE) {
            // Column indices of the target cells
            // 1 = Name, 2 = Email, 5 = DOB
            const TARGET_VALUE = 'Accountant';
            const COLUMN_INDICES = [1, 2, 5];

            const rowIdx = row.index();

            for (const colIdx of COLUMN_INDICES) {
                const targetCell = tableInstance.cell(rowIdx, colIdx);

                if (!targetCell.node()) return; // Avoid error if cell doesn't exist

                if (row.data().position === TARGET_VALUE) {
                    $(targetCell.node()).addClass('cell-disabled');
                } else {
                    $(targetCell.node()).removeClass('cell-disabled');
                }
            }
        }

        function cellUpdateCallback(updatedCell, updatedRow, oldValue) {
            console.log('------------------- updatedCell', updatedCell, $(updatedCell.node()));
            // validate whether a valid option is selected
            // fallback to oldValue if new value is null/empty
            // e.g: user searched for an option but selected non
            if ($(updatedCell.node()).hasClass('dt-type-dropdown')) {
                if (!updatedCell.data())
                    updatedCell.data(oldValue);

                const option = POSITION_OPTIONS.find(p => p.display == updatedCell.data());
                if (!option)
                    updatedCell.data(oldValue);

                // conditionally disable column
                disableCertainCell(updatedRow);
            }

            console.log('The new value for the cell is: ' + updatedCell.data());
            console.log('The values for each cell in that row are: ' + updatedRow.data());
            identifyInvalidCells();
            printCurrentTableData();
        }

        function getColumnNameForCurrentCell(td) {
            // Get the clicked cell
            const cell = DATA_TABLE.cell(td);

            // Get column index of the clicked cell
            const columnIndex = cell.index().column;

            // Get the column name from the DataTable settings
            const columnName = DATA_TABLE.column(columnIndex).header().textContent;

            return columnName;
        }

        function deleteRow(id) {
            // Show the modal
            $('#deleteConfirmationModal').modal('show');

            // Set the ID of the row to be deleted in a data attribute
            $('#confirmDelete').data('row-id', id);

            // Add an event listener to the delete button
            $('#confirmDelete').off('click').on('click', function () {
                const rowId = $(this).data('row-id');
                console.log('Deleting row with ID:', rowId);

                DATA_TABLE
                    .row($(`[data-id="${rowId}"]`).closest('tr'))
                    .remove()
                    .draw(false);

                printCurrentTableData();

                // Hide the modal after deletion
                $('#deleteConfirmationModal').modal('hide');
            });
        }

        function findDuplicateRows() {
            console.log('find duplcates');
            const data = DATA_TABLE.rows().data().toArray();
            const duplicates = data.reduce((acc, item) => {
                const key = `${item.office}-${item.position}`;
                acc[key] ? acc[key].push(item) : acc[key] = [item];
                return acc;
            }, {});

            const result = Object.values(duplicates).filter(arr => arr.length > 1).flat();
            console.log(`Found ${result.length} duplicates`);
            return result;
        }

        function identifyInvalidCells() {
            let [dropdownError, datePickerError, numericError, otherError, positionsError, emailError] = [0, 0, 0, 0, 0, 0];

            $('td').removeClass('invalid-data');
            findDuplicateRows();

            let officeLoation = '';
            $(`#SimpleDataTable td`).each(function () {

                // skip validtion for checkbox column
                if ($(this).hasClass('dt-type-checkbox'))
                    return true;

                const textContent = $(this).text().trim();
                let valid = true;

                // get column name
                const columnName = getColumnNameForCurrentCell(this);

                // for 'office' column, save the value;
                // later use it to validate 'position' value
                if (columnName.toLowerCase() == 'office')
                    officeLoation = textContent;

                if ($(this).hasClass('dt-type-dropdown')) {
                    // data type: select option
                    // rule: must exist in position dropdown list

                    // Validate Positions Column
                    // 1. must exist in dropdown list
                    // 2. must align with office location
                    if (columnName.toLowerCase() == 'position') {
                        //console.log('positions dropdown = ', textContent);
                        const optionExist = POSITION_OPTIONS.find(p => p.display == textContent)
                        if (!optionExist) {
                            valid = false;
                            dropdownError++;
                        }

                        // office location is not null or empty
                        if (!!officeLoation) {
                            const mapping = OFFICE_POSITION_MAPPING.find(x => x.location == officeLoation);
                            if (!mapping) {
                                valid = false;
                                positionsError++;
                            } else {
                                const option = mapping.positions.find(x => x == textContent);
                                if (!option) {
                                    valid = false;
                                    positionsError++;
                                }
                            }
                        }
                    }

                } else if ($(this).hasClass('dt-type-datepicker')) {
                    // data type: date picker
                    // rule: can't be empty && must be valid date
                    if (!textContent || textContent.toLowerCase().includes('invalid date')) {
                        datePickerError++;
                        valid = false;
                    }
                } else if ($(this).hasClass('dt-type-numeric')) {
                    // data type: numeric
                    // rule: can't be empty && must be a number
                    const cleaned = textContent.replace(/[^0-9.-]/g, '');
                    const number = parseFloat(cleaned);
                    if (!textContent || isNaN(number)) {
                        numericError++;
                        valid = false;
                    }
                } else if ($(this).hasClass('dt-type-email')) {
                    // data type: email
                    // rule: must be a valid email
                    // note: there can be multiple email addresses separted by EMAIL_SEPARATOR
                    const emails = textContent
                        .split(EMAIL_SEPARATOR)
                        .map(e => e.trim());
                    for (const email of emails) {
                        if (!EMAIL_REGEX.test(email)) {
                            emailError++;
                            valid = false;
                        }
                    }
                } else {
                    // data type: else, string and all
                    // rule: can't be null OR empty
                    if (!textContent) {
                        otherError++;
                        valid = false;
                    }
                }

                if (!valid)
                    $(this).addClass('invalid-data');
            });

            return ({ dropdownError, datePickerError, numericError, otherError, positionsError, emailError });
        }

        function showAlert(msg, isSuccess = true) {
            const alertClass = isSuccess ? 'alert-success' : 'alert-danger';
            const alertHtml = `<div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                ${msg}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>`;
            $('.alert-wrapper').html(alertHtml);
        }

        function showErrorAlertWithValidationSummary(msg, validationErrors) {
            const { dropdownError, datePickerError, numericError, otherError, positionsError, emailError } = validationErrors;
            let errorSummary = ``;

            if (emailError > 0)
                errorSummary += `<li> <b>${emailError}</b> Invalid Email Address  </li>`;
            if (dropdownError > 0)
                errorSummary += `<li> <b>${dropdownError}</b> Invalid Dropdown Value  </li>`;
            if (datePickerError > 0)
                errorSummary += `<li> <b>${datePickerError}</b> Invalid DatePicker Value  </li>`;
            if (numericError > 0)
                errorSummary += `<li> <b>${numericError}</b> Invalid Numeric Value  </li>`;
            if (otherError > 0)
                errorSummary += `<li> <b>${otherError}</b> Invalid String Value  </li>`;
            if (positionsError > 0)
                errorSummary += `<li> <b>${positionsError}</b> Poistion options doesn't exist in selected office location  </li>`;

            const duplicateRows = findDuplicateRows();
            if (duplicateRows.length > 0)
                errorSummary += `<li> <b>${duplicateRows.length}</b> Duplicate rows (office <> position) </li>`;

            const alertHtml = `<div class="alert alert-danger alert-dismissible fade show" role="alert">
                ${msg}
                <div class="mt-3"><ul> ${errorSummary} </ul></div>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>`;
            $('.alert-wrapper').html(alertHtml);
        }

        function toggleUploadButtonDisableState() {
            const source = $('#SelectSource').val();
            const type = $('#SelectType').val();
            if (source == 0 || type == 0) {
                $('.btn-show-upload-modal').attr('disabled', true);
            } else {
                $('.btn-show-upload-modal').removeAttr('disabled', true);
            }

            console.log('toggleUploadButtonDisableState', source, type);
        }

        // TREE VIEW SAMPLE DATA
        const DUMMY_DATA = [
            { id: 1, name: 'Australia', parent: 0 },
            { id: 4, name: 'New South Wales', parent: 1 },
            { id: 5, name: 'Queensland', parent: 1 },
            { id: 6, name: 'South Australia', parent: 1 },
            { id: 7, name: 'Tasmania', parent: 1 },
            { id: 8, name: 'Victoria', parent: 1 },
            { id: 9, name: 'Western Australia', parent: 1 },
            { id: 2, name: 'Bangladesh', parent: 0 },
            { id: 10, name: 'Barisal', parent: 2 },
            { id: 11, name: 'Chottagong', parent: 2 },
            { id: 12, name: 'Dhaka', parent: 2 },
            { id: 18, name: 'Dhaka', parent: 12 },
            { id: 24, name: 'All Educational Institudes', parent: 18 },
            { id: 27, name: 'Schools (secondary, higher secondary, madrasha)', parent: 24 },
            { id: 28, name: 'College', parent: 24 },
            { id: 29, name: 'Madrashah', parent: 24 },
            { id: 25, name: 'Hospitals', parent: 18 },
            { id: 26, name: 'Restaurants', parent: 18 },
            { id: 19, name: 'Faridpur', parent: 12 },
            { id: 20, name: 'Gazipur', parent: 12 },
            { id: 21, name: 'Gopalganj', parent: 12 },
            { id: 22, name: 'Kishoreonj', parent: 12 },
            { id: 23, name: 'Madaripur', parent: 12 },
            { id: 13, name: 'Khulna', parent: 2 },
            { id: 14, name: 'Mymensingh', parent: 2 },
            { id: 15, name: 'Rajshahi', parent: 2 },
            { id: 16, name: 'Rangpur', parent: 2 },
            { id: 17, name: 'Sylhet', parent: 2 },
            { id: 3, name: 'United States', parent: 0 },
        ];

        function createNode(rootEl, items, idPrefix, dataPrefix, level = 1) {
            for (const item of items) {
                const id = item.id;
                const idAttr = idPrefix + id;
                const dataAttr = dataPrefix + id;
                const children = DUMMY_DATA.filter(x => x.parent == id);

                // Disable checkboxes for levels 1 to TREEVIEW_SELECTION_LEVEL
                const isDisabled = level < TREEVIEW_SELECTION_LEVEL ? 'disabled' : '';

                const li = $('<li></li>');
                li.append(`
                    <label class="${children.length == 0 ? 'ml-3' : ''}">
                        <input
                            class="${children.length == 0 ? 'hummingbird-end-node' : ''}"
                            type="checkbox"
                            id="${idAttr}"
                            data-id="${dataAttr}"
                            ${isDisabled} />
                        ${item.name}
                    </label>
                `).appendTo(rootEl);

                if (children.length > 0) {
                    $('<i />', { 'class': 'bi bi-plus' }).prependTo(li);
                    createNode($('<ul></ul>'), children, `${idAttr}-`, `${dataAttr}-`, level + 1).appendTo(li);
                }
            }
            return rootEl;
        }

        function initializeTreeView() {
            // asuming first-level items' parent = 0;
            const items = DUMMY_DATA.filter(x => x.parent == 0);
            const selector = $('#treeview');
            const treeMarkup = createNode(selector, items, 'node-', 'custom-');
            //
            selector
                .append(treeMarkup)
                .hummingbird();
        }

        function disableTreeViewHigherLevels() {
            $('#treeview').find('input[type="checkbox"]').each(function () {
                const level = $(this).parents('ul').length; // Determines the depth level

                if (level < TREEVIEW_SELECTION_LEVEL) {
                    $(this).prop('checked', false).prop('disabled', true);
                }
            });
        }

        function exportToExcel(jsonData) {
            // Convert JSON to worksheet
            let worksheet = XLSX.utils.json_to_sheet(jsonData);

            // Create a new workbook and append the worksheet
            let workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Sheet1');

            // Save to Excel file
            XLSX.writeFile(workbook, `export_${Date.now()}.xlsx`);
        }

        function appendTableRowsCount() {
            let tableEl = $('#SimpleDataTable').DataTable();
            let totalRows = tableEl.rows().count();
            totalRows = totalRows > 99 ? '99+' : totalRows;
            if ($('#nav-editing-tab').find('.badge-count').length == 0)
                $('#nav-editing-tab').append(`<div class="badge-count">${totalRows}</div>`);
            else
                $('#nav-editing-tab').find('.badge-count').text(totalRows);

            tableEl = $('#PreviewDataTable').DataTable();
            totalRows = tableEl.rows().count();
            totalRows = totalRows > 99 ? '99+' : totalRows;
            if ($('#nav-preview-tab').find('.badge-count').length == 0)
                $('#nav-preview-tab').append(`<div class="badge-count">${totalRows}</div>`);
            else
                $('#nav-preview-tab').find('.badge-count').text(totalRows);
        }

        $(document).ready(function () {

            IdleSessionManager.init({
                idleSeconds: 3000,
                countdownSeconds: 3000,
                redirectUrl: 'session-expired.html',
            });

            // $('.btn-show-upload-modal').click(function () {
            //     modal.show();
            // });

            // $('.launch-upload-modal').click(function () {
            //     $('.pre-content-wrapper').hide();
            //     $('.main-content-wrapper').show();
            //     initializeDataTable('#SimpleDataTable', DATA);
            // });

            initializeDataTable('#SimpleDataTable', DATA);

            // Numeric Validation
            $(document).on('keydown', '#SimpleDataTable .form-control', function (e) {

                // Early trigger submit on 'Enter' press
                if (e.key === 'Enter') {
                    console.log('ENTER PRESSED, SUBMIT & QUIT EDITING');
                    $(this).blur();
                }
                const parent = $(this).closest('td');
                if (!!parent && parent.hasClass('dt-type-numeric')) {
                    console.log('VALIDATE NUMBERS');
                    if (
                        (e.key.length === 1 && !/[0-9\-]/.test(e.key)) ||  // Allow numbers and minus sign
                        (e.key === '-' && this.value.includes('-')) ||     // Prevent more than one minus sign
                        (e.key === '-' && this.selectionStart !== 0)       // Allow minus only at the beginning
                    ) {
                        e.preventDefault();
                    }
                }
            });

            // Dropdown select event
            $(document).on('click', '#editableDropdown .dropdown-item', function () {
                const textContent = $(this).text().trim();
                console.log('Selected dropdown item = ', textContent);
            });

            // Add new row to datatable
            $('.btn-add-row').click(function () {

                // Initialize DataTable with empty [] data if not already initialized
                if (!DataTable.isDataTable('#SimpleDataTable'))
                    initializeDataTable('#SimpleDataTable', []);

                const newRowData = {
                    first_name: '',
                    last_name: '',
                    position: '',
                    email: '',
                    office: '',
                    extn: '',
                    age: '',
                    salary: '',
                    dob: '',
                    active: "0",
                    id: DATA_TABLE.rows().data().toArray().length + 10
                };

                // Add new row to the table
                DATA_TABLE.row.add(newRowData).draw();
            });

            $('#confirmSubmit').click(function () {
                console.log('submit data');

                // exit edit mode for all cells that are in edit mode
                $('.editing .form-control, .editing .form-select').trigger('change');

                $('td').removeClass('invalid-data');

                // Initialize DataTable with empty [] data if not already initialized
                if (!DataTable.isDataTable('#SimpleDataTable'))
                    initializeDataTable('#SimpleDataTable', []);

                const data = DATA_TABLE.rows().data().toArray();

                // run validations
                const validationErrors = identifyInvalidCells();

                if ($('#SimpleDataTable td.invalid-data').length) {
                    showErrorAlertWithValidationSummary(VALIDATION_ERROR_MSG, validationErrors);
                } else {
                    console.log('all valid, submit to server');
                    showAlert('Submit Success');

                    // clear data-table
                    DATA_TABLE.clear().draw();
                }

                // hide modal
                $('#submitConfirmationModal').modal('hide');
            });

            // launch confirm submit modal
            $('.btn-submit-data').click(function () {

                // get select-option values
                const source = $('#SelectSource').val();
                const type = $('#SelectType').val();

                // show values on modal
                $('.txt-source').text(source);
                $('.txt-type').text(type);

                // show confirmation modal
                $('#submitConfirmationModal').modal('show');
            });

            // upload button's disable state
            $('#SelectSource, #SelectType').change(toggleUploadButtonDisableState);

            // Go to link
            $('.btn-go-to-link').click(function () {

                // get select-option values
                const source = $('#SelectSource').val();
                const type = $('#SelectType').val();

                //send to another link
                const url = `someurl?source=${source}&type=${type}`;
                window.open(url, '_blank');
            });

            // invoke initialize tree view
            initializeTreeView();

            $("#treeview").on("CheckUncheckDone", function () {
                var List = { "id": [], "dataid": [], "text": [] };
                $("#treeview").hummingbird("getChecked", { list: List, onlyEndNodes: true, onlyParents: false, fromThis: false });
                let cleanedData = List.text.map(item => item.replace('', '').trim());
                console.log('CheckUncheckDone', cleanedData);
                $('#btnSourceDropdown').text(`${List.id.length} selected`);

                disableTreeViewHigherLevels();
            });

            $('#SelectDate').datepicker();

            $(document).on('keydown', function (e) {
                if (e.key === 'Escape') {
                    $('.editing .form-control, .editing .form-select, .editing .form-check-input').trigger('change');
                }
            });

            $('.btn-export-to-xls').click(function () {
                if (!DATA_TABLE)
                    return alert('No data to export, please initialize the table first...');

                const data = DATA_TABLE.rows().data().toArray();
                exportToExcel(data);
            });

            $('#PreviewDataTable').on('draw.dt', function () {
                console.log('-------------the other -- - data table drawn event--------------');
                appendTableRowsCount();
            });

            $('#SimpleDataTable').on('draw.dt', function () {
                console.log('-------------data table drawn event--------------');

                // set Tab-indices [for keyboard navigation]
                $('td.editable, .focusable-element-wrapper').attr('tabindex', 0);
                // focus the table so the focus don't start from the parent <body>
                $(this).focus();

                //Re-bind event listeners after DataTable redraw

                $(this).off('change').on('change', '.ejbeatycelledit-multi', function () {
                    console.log('checkbox changed');
                    const $clicked = $(this);
                    const isYes = $clicked.data('value') == 1;

                    //Uncheck the other checkbox (mutual exclusivity)
                    const $checkboxesInRow = $clicked.closest('td').find('.ejbeatycelledit-multi');
                    $checkboxesInRow.prop('checked', false);  //Uncheck all
                    $clicked.prop('checked', true);           //Check the clicked checkbox

                    //Get the new value: 1 for 'Yes', 2 for 'No'
                    const newValue = isYes ? 1 : 2;

                    //Update the row with the new value
                    const $cell = $clicked.closest('td');
                    const table = $cell.closest('table').DataTable();
                    const row = table.row($clicked.closest('tr'));
                    const cell = row.cell($cell);

                    // Set value for current cell
                    cell.data(newValue);

                    //  Set value for another column in the same row
                    const targetColIndex = 6; // Salary column index (0-based)
                    const newRelatedValue = isYes ? 5000 : 0;

                    // Use cell() to get the target cell, then update its data
                    row.cell(row.index(), targetColIndex).data(newRelatedValue);

                    // Re-draw the row without full table redraw
                    row.invalidate().draw(false);
                });

                //Rebind the CheckAll event listener (make sure this works after redraw)
                $(this).on('change', '#checkAll', function () {
                    console.log('check all clicked');
                    const isChecked = $(this).is(':checked');

                    DATA_TABLE.rows().every(function () {
                        const cell = this.cell(this.index(), 0);
                        const data = this.data();

                        data.active = isChecked ? 1 : 2;
                        this.data(data);

                        cell.invalidate().render('display');
                    });

                    DATA_TABLE.draw(false);
                    identifyInvalidCells();
                    printCurrentTableData();
                });

                // Numeric Validation
                $(this).on('keydown', '.form-control', function (e) {

                    // Early trigger submit on 'Enter' press
                    if (e.key === 'Enter') {
                        console.log('ENTER PRESSED, SUBMIT & QUIT EDITING');
                        $(this).blur();
                    }

                    if ($(this).hasClass('hasDatepicker')) {
                        console.log('---------------------- HAS DATEPICKER ------------------------------')
                        const iconEl = $(this).next('.input-group-text');
                        if (iconEl.length > 0)
                            iconEl.click();
                    }

                    const parent = $(this).closest('td');
                    if (!!parent) {
                        if (parent.hasClass('dt-type-numeric')) {
                            console.log('VALIDATE NUMBERS');
                            if (
                                (e.key.length === 1 && !/[0-9\.\-]/.test(e.key)) ||              // Allow digits, dot, minus
                                (e.key === '-' && this.value.includes('-')) ||                  // Only one minus sign
                                (e.key === '-' && this.selectionStart !== 0) ||                 // Minus must be at the beginning
                                (e.key === '.' && this.value.includes('.'))                     // Only one decimal point
                            ) {
                                e.preventDefault();
                            }
                        } else {
                            const classes = parent.attr('class')?.split(/\s+/);
                            const lenClass = classes?.find(c => c.startsWith('len-'));
                            if (!!lenClass) {
                                console.log('VALIDATE STRING LENGTH');
                                const maxLen = parseInt(lenClass.slice(4), 10);
                                if (this.value.length >= maxLen)
                                    e.preventDefault();
                            }
                        }
                    }
                });

                $(document).on('keydown', 'td.editable', function (e) {
                    // Only trigger if the cell itself is focused
                    if (e.key === 'Enter' && e.target === this) {
                        console.log('accessibility > Enter pressed');
                        e.preventDefault();

                        // Activate edit mode (simulate a click)
                        $(this).trigger('click');
                    }
                });


                //
                appendTableRowsCount();
            });

            $('button[data-bs-toggle="tab"]').on('shown.bs.tab', function (event) {
                console.log('tab changed');
                $('#PreviewDataTable').DataTable().columns.adjust().draw(false);
                console.log('newly activated tab', event.target);
                console.log('previous active tab', event.relatedTarget);
            });

            $('#PreviewDataTable').on('change', 'input[type="checkbox"]', function () {
                const $checkbox = $(this);
                const isChecked = $checkbox.is(':checked') ? 1 : 0;

                // 1. Get the DataTable instance
                const table = $('#PreviewDataTable').DataTable();

                // 2. Get the row and its data
                const rowEl = $checkbox.closest('tr');
                const row = table.row(rowEl);
                const rowData = row.data();

                // 3. Update the data
                rowData.active = isChecked;

                // 4. Set the updated data and redraw
                row.data(rowData).invalidate().draw(false);
            });


        });
    </script>
</body>

</html>